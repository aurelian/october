#!/usr/bin/env ruby

@root = File.expand_path("..", File.dirname(__FILE__))

def child
  @child
end

def spawn!
  @child = fork do
    ENV['OCTOBER_ENV'] = ARGV.shift

    require File.join(@root, "boot")
    require 'october'

    @bot = October::Base.new
    @bot.start
  end
end

loop do
  begin
    Process.wait(spawn!)
    puts "process #{child} ended"
  rescue Errno::ECHILD
    puts "process #{child} died or was killed"
  end

  puts "spawning new one in next iteration"

  sleep(1) # throttle spawning in case anything fails
end

